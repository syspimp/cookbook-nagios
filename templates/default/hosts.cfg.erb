# Host definitions
#
# Autogenerated by Chef.

<%# handle the nagios node differently than others to prevent failures in bootstrap scenarios %>
define host {
  use server
  address <%= node['nagios']['server']['monitored_client_interface'] ? node['network']["ipaddress_#{node['nagios']['server']['monitored_client_interface']}"] : node['ipaddress'] %>
  <% if node[node['nagios']['host_name_attribute']] %>
  host_name <%= node['nagios']['server']['normalize_hostname'] ? node[node['nagios']['host_name_attribute']].downcase : node[node['nagios']['host_name_attribute']] %>
  <% else %>
  host_name <%= node['nagios']['server']['normalize_hostname'] ? node['hostname'].downcase : node['hostname'] %>
  <% end %>
  hostgroups <% if node['nagios']['multi_environment_monitoring'] -%><%= node.chef_environment %>,<% end -%>all,<%= node['os'] %>,<%= node['roles'].join(",") %><% if !node['roles'].include?(node['nagios']['server_role']) %>,<%= node['nagios']['server_role'] %><% end -%>
  <% if node['nagios']['server']['host_notes'] %>
  notes <%= node['nagios']['server']['host_notes'] %>
  <% end %>
  <% if node['nagios']['server']['host_notes_url'] %>
  notes_url <%= node['nagios']['server']['host_notes_url'] %>
  <% end %>
}

<% @nodes.each do |n| -%>
<% unless n.name == node.name -%>
define host {
  use server
  <% # decide whether to use internal or external IP addresses for this node
  # if the nagios server is not in the cloud, always use public IP addresses for cloud nodes.
  # if the nagios server is in the cloud, use private IP addresses for any
  #   cloud servers in the same cloud, public IPs for servers in other clouds
  #   (where other is defined by node['cloud']['provider'])
  # if the cloud IP is nil then use the standard IP address attribute.  This is a work around
  #   for OHAI incorrectly identifying systems on Cisco hardware as being in Rackspace
  if node['cloud'].nil? && !n['cloud'].nil?
    ip = node['ipaddress'].include?('.') ? n['cloud']['public_ipv4'] : n['ipaddress']
  elsif !node['cloud'].nil? && n['cloud']['provider'] != node['cloud']['provider']
    ip = node['ipaddress'].include?('.') ? n['cloud']['public_ipv4'] : n['ipaddress']
  elsif node['nagios']['server']['monitored_client_interface']
    ip = n['network']["ipaddress_#{node['nagios']['server']['monitored_client_interface']}"]
    if not ip
      Chef::Log.warn("node['nagios']['server']['monitored_client_interface'] was specified for #{n['name']} but n['network']['ipaddress_#{node['nagios']['server']['monitored_client_interface']}'] was not set. Using n['ipaddress']") %>
# WARNING: This host doesn't have a monitored_client_interface defined!
# Using <%= n['ipaddress'] %> instead.
    <% ip = n['ipaddress']
     end
   else
    ip = n['ipaddress']
  end %>
  address <%= ip %>
  <% # arista devices don't have fqdn hostname, the node name is the fqdn
  if n[node['nagios']['host_name_attribute']] && !n['roles'].include?('arista-switch') %>
  host_name <%= node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']] %>
  <% elsif n['roles'].include?('arista-switch') %>
  host_name <%= node['nagios']['server']['normalize_hostname'] ? n['chef_client']['config']['node_name'].downcase : n['chef_client']['config']['node_name'] %>
  <% else %>
  host_name <%= node['nagios']['server']['normalize_hostname'] ? n['hostname'].downcase : n['hostname'] %>
  <% end %>
  <% if node['nagios']['multi_environment_monitoring'] -%>
  <% if n.roles.nil? || n.roles.length == 0 -%>
  hostgroups all,<%= n.os %>, <%= n.chef_environment %>
  <% else -%>
  hostgroups all,<%= (n.roles & @hostgroups).join(",") %>,<%= n.os %>, <%= n.chef_environment %>
  <% end -%>
  <% elsif -%>
  <% if n.roles.nil? || n.roles.length == 0 -%>
  hostgroups all,<%= n.os %>
  <% else -%>
  hostgroups all,<%= (n.roles & @hostgroups).join(",") %>,<%= n['os'] %>
  <% end -%>
  <% end -%>
  <% if node['nagios']['server']['host_notes'] %>
  notes <%= node['nagios']['server']['host_notes'] %>
  <% end %>
  <% if node['nagios']['server']['host_notes_url'] %>
  notes_url <%= node['nagios']['server']['host_notes_url'] %>
  <% end %>
}
<% end -%>
<% end -%>

<% unless @unmanaged_hosts.nil? -%>
<% @unmanaged_hosts.each do |n| -%>
define host {
  use server
  address <%= n['address'] %>
  <% if n['fqdn'] -%>
  host_name <%= node['nagios']['server']['normalize_hostname'] ? n['fqdn'].downcase : n['fqdn'] %>
  <% else -%>
  host_name <%= node['nagios']['server']['normalize_hostname'] ? n['id'].downcase : n['id'] %>
  <% end -%>
  hostgroups all,<%= n['hostgroups'].join(",") %>
  notifications_enabled <%= n['notifications'] %>
  <% if node['nagios']['server']['host_notes'] %>
  notes <%= node['nagios']['server']['host_notes'] %>
  <% end %>
  <% if node['nagios']['server']['host_notes_url'] %>
  notes_url <%= node['nagios']['server']['host_notes_url'] %>
  <% end %>
}
<% end -%>
<% end -%>
